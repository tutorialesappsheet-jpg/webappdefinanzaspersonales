<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- STATE MANAGEMENT ---
  const state = {
    accounts: [],
    categories: [],
    transactions: [],
    goals: [],
    debts: [],
    currentView: 'dashboard'
  };

  const currencyFormatter = new Intl.NumberFormat('es-SV', { style: 'currency', currency: 'USD' });

  // --- UI ELEMENTS ---
  const loader = document.getElementById('loader');
  const appContent = document.getElementById('app-content');
  const mainActionBtn = document.getElementById('main-action-btn');
  const navLinksContainer = document.getElementById('nav-links');
  const modalContainer = document.getElementById('modal-container');
  const notificationContainer = document.getElementById('notification-container');
  const refreshBtn = document.getElementById('refresh-btn');
  const mainActionIcon = document.getElementById('main-action-icon');
  const mainActionText = document.getElementById('main-action-text');
  const hamburgerBtn = document.getElementById('hamburger-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  
  let mainChart = null;
  let expenseChart = null;

  // --- INITIALIZATION ---
  function initialize() {
    document.getElementById('mobile-menu')?.classList.add('hidden');
    loader.style.display = 'flex';
    google.script.run
      .withSuccessHandler(data => {
        if (!data || typeof data !== 'object') {
          showNotification('error', 'Respuesta inv√°lida o nula del servidor.');
          loader.style.display = 'none';
          return;
        }
        if (data.initializationError) { showNotification('error', data.initializationError); }
        if (data.error && !data.initializationError) { showNotification('error', data.error); loader.style.display = 'none'; return; }
        Object.assign(state, data);
        navigateTo(window.location.hash.substring(1) || 'dashboard');
        loader.style.display = 'none';
      })
      .withFailureHandler(error => {
        showNotification('error', `Error de conexi√≥n: ${error.message}`);
        loader.style.display = 'none';
      })
      .getInitialData();
  }
  
  // --- NAVIGATION ---
  navLinksContainer.addEventListener('click', e => {
    const button = e.target.closest('.nav-tab');
    if (button) {
      e.preventDefault();
      navigateTo(button.dataset.view);
    }
  });

  function navigateTo(view) {
      state.currentView = view || 'dashboard';
      window.location.hash = state.currentView;
      document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.mobile-nav-button').forEach(b => b.classList.remove('active'));
      document.querySelector(`.nav-tab[data-view="${state.currentView}"]`)?.classList.add('active');
      document.querySelector(`.mobile-nav-button[data-view="${state.currentView}"]`)?.classList.add('active');

      const config = viewConfig[state.currentView] || viewConfig.dashboard;
      
      mainActionBtn.onclick = config.action;
      mainActionText.textContent = config.btnText;
      mainActionIcon.innerHTML = `<i class="ph ${config.iconClass}"></i>`;
      
      renderCurrentView();
  }

const viewConfig = {
    dashboard:    { title: 'Dashboard',       btnText: 'Nueva Transacci√≥n', iconClass: 'ph-plus', action: () => showTransactionModal() },
    transactions: { title: 'Transacciones',   btnText: 'Nueva Transacci√≥n', iconClass: 'ph-plus', action: () => showTransactionModal() },
    accounts:     { title: 'Cuentas',         btnText: 'Nueva Cuenta',      iconClass: 'ph-bank', action: () => showAccountModal() },
    categories:   { title: 'Categor√≠as',      btnText: 'Nueva Categor√≠a',   iconClass: 'ph-tag', action: () => showCategoryModal() },
    goals:        { title: 'Metas de Ahorro', btnText: 'Nueva Meta',        iconClass: 'ph-rocket-launch', action: () => showGoalModal() },
    debts:        { title: 'Deudas',          btnText: 'Nueva Deuda',       iconClass: 'ph-credit-card', action: () => showDebtModal() }
};

  // --- MAIN RENDER FUNCTION ---
  function renderCurrentView() {
    appContent.innerHTML = '';
    switch (state.currentView) {
      case 'dashboard': renderDashboard(); break;
      case 'transactions': renderTable('transactions'); break;
      case 'accounts': renderAccountCards(); break;
      case 'categories': renderTable('categories'); break;
      case 'goals': renderGoals(); break;
      case 'debts': renderDebts(); break;
      default: renderDashboard(); break;
    }
  }

  // --- RENDERERS ---
  function renderDashboard() {
    const totalBalance = state.accounts.reduce((sum, acc) => sum + acc.SaldoInicial, 0) + state.transactions.reduce((sum, t) => sum + (t.Tipo === 'ingreso' ? t.Monto : -t.Monto), 0);
    const now = new Date();
    const monthlyTransactions = state.transactions.filter(t => new Date(t.Fecha).getMonth() === now.getMonth() && new Date(t.Fecha).getFullYear() === now.getFullYear());
    
    const monthlyIncome = monthlyTransactions.filter(t => t.Tipo === 'ingreso' && t.Categoria !== 'Transferencia Entrante').reduce((sum, t) => sum + t.Monto, 0);
    const monthlyExpense = monthlyTransactions.filter(t => t.Tipo === 'gasto' && t.Categoria !== 'Transferencia Saliente').reduce((sum, t) => sum + t.Monto, 0);
    const monthlyGoalContributions = monthlyTransactions.filter(t => t.Categoria === 'Transferencia Saliente').reduce((sum, t) => sum + t.Monto, 0);
    const monthlyCashflow = monthlyIncome - monthlyExpense;
    const totalDebtPending = state.debts.reduce((sum, debt) => sum + (debt.MontoTotal - (debt.MontoPagado || 0)), 0);

    const accountsWithBalance = state.accounts.map(account => {
        const accountTransactions = state.transactions.filter(t => t.CuentaID === account.ID);
        const ingresos = accountTransactions.filter(t => t.Tipo === 'ingreso').reduce((sum, t) => sum + t.Monto, 0);
        const egresos = accountTransactions.filter(t => t.Tipo === 'gasto').reduce((sum, t) => sum + t.Monto, 0);
        const saldoActual = account.SaldoInicial + ingresos - egresos;
        return { ...account, ingresos, egresos, saldoActual };
    }).filter(account => account.saldoActual > 0);

    const accountCardsHtml = accountsWithBalance.length > 0 ? `
        <div class="mb-8"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            ${accountsWithBalance.map(account => `
                <div class="cuenta-card-dashboard">
                    <div class="card-title-dashboard">üí≥ ${account.Nombre}</div>
                    <div class="card-data-dashboard"><span>üìà Ingresos:</span><span class="ingreso-val-dashboard">${currencyFormatter.format(account.ingresos)}</span></div>
                    <div class="card-data-dashboard"><span>üìâ Egresos:</span><span class="egreso-val-dashboard">${currencyFormatter.format(account.egresos)}</span></div>
                    <div class="card-saldo-highlight-dashboard"><span class="saldo-label-dashboard">Saldo:</span><span class="saldo-value-dashboard">${currencyFormatter.format(account.saldoActual)}</span></div>
                </div>`).join('')}
        </div></div>` : '';

    appContent.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6 mb-8">
        <div class="stat-card-new"><h3><i class="ph ph-trend-up"></i>Ingresos del Mes</h3><div class="value-highlight green">${currencyFormatter.format(monthlyIncome)}</div></div>
        <div class="stat-card-new"><h3><i class="ph ph-trend-down"></i>Gastos del Mes</h3><div class="value-highlight red">${currencyFormatter.format(monthlyExpense)}</div></div>
        <div class="stat-card-new"><h3><i class="ph ph-piggy-bank"></i>Ahorrado del Mes</h3><div class="value-highlight purple">${currencyFormatter.format(monthlyGoalContributions)}</div></div>
        <div class="stat-card-new"><h3><i class="ph ph-credit-card"></i>Deuda Pendiente</h3><div class="value-highlight orange">${currencyFormatter.format(totalDebtPending)}</div></div>
        <div class="stat-card-new"><h3><i class="ph ph-arrows-left-right"></i>Flujo de Caja</h3><div class="value-highlight blue">${currencyFormatter.format(monthlyCashflow)}</div></div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="card lg:col-span-2 flex flex-col h-[30rem]">
          <h3 class="card-title">Flujo de Dinero Anual</h3>
          <div class="relative flex-grow w-full"><canvas id="mainChart"></canvas></div>
        </div>
        <div class="card flex flex-col h-[30rem]">
          <h3 class="card-title mb-4">Gastos por Categor√≠a (Mes)</h3>
          <div class="relative flex-grow w-full"><canvas id="expenseChart"></canvas></div>
          <div id="expense-legend" class="mt-4"></div>
        </div>
      </div>
      ${accountCardsHtml}`;

    renderCharts(now, monthlyTransactions);
  }function renderCharts(now, monthlyTransactions) {
      Chart.defaults.color = '#a0a0a0';
      const annualData = { incomes: Array(12).fill(0), expenses: Array(12).fill(0) };
      state.transactions.forEach(t => {
          const date = new Date(t.Fecha);
          if (date.getFullYear() === now.getFullYear()) {
              const month = date.getMonth();
              if (t.Tipo === 'ingreso' && t.Categoria !== 'Transferencia Entrante') annualData.incomes[month] += t.Monto;
              else if (t.Tipo === 'gasto' && t.Categoria !== 'Transferencia Saliente') annualData.expenses[month] += t.Monto;
          }
      });

      if (mainChart) mainChart.destroy();
      
      mainChart = new Chart(document.getElementById('mainChart').getContext('2d'), { 
          type: 'bar', 
          data: { 
              labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'], 
              datasets: [{ 
                  label: 'Ingresos', 
                  data: annualData.incomes, 
                  backgroundColor: 'rgba(74, 222, 128, 0.7)',
                  borderColor: 'rgba(74, 222, 128, 1)',
                  borderWidth: 2,
                  borderRadius: 6
              }, { 
                  label: 'Gastos', 
                  data: annualData.expenses, 
                  backgroundColor: 'rgba(245, 7, 89, 0.7)',
                  borderColor: 'rgba(245, 7, 89, 1)',
                  borderWidth: 2,
                  borderRadius: 6
              }] 
          }, 
          options: { 
              responsive: true, 
              maintainAspectRatio: false,
              scales: {
                  y: { grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                  x: { grid: { display: false } }
              }
          }
      });
      
      const expenseData = {};
      const monthlyExpenses = monthlyTransactions.filter(t => t.Tipo === 'gasto' && t.Categoria !== 'Transferencia Saliente');
      monthlyExpenses.forEach(t => { 
          expenseData[t.Categoria] = (expenseData[t.Categoria] || 0) + t.Monto; 
      });
      const totalMonthlyExpense = monthlyExpenses.reduce((sum, t) => sum + t.Monto, 0);

      const sortedCategories = Object.keys(expenseData).sort((a, b) => expenseData[b] - expenseData[a]);
      const sortedValues = sortedCategories.map(key => expenseData[key]);
      
      const legendContainer = document.getElementById('expense-legend');
      legendContainer.innerHTML = '';
      
      const colors = ['#f50759', '#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#ec4899', '#0ea5e9', '#ef4444'];

      sortedCategories.forEach((category, index) => {
          const color = colors[index % colors.length];
          const value = expenseData[category];
          const percentage = totalMonthlyExpense > 0 ? ((value / totalMonthlyExpense) * 100).toFixed(1) : 0;
          
          const itemHtml = `
              <div class="legend-item">
                  <div class="legend-color-dot" style="background-color: ${color};"></div>
                  <div class="legend-label" title="${category}">${category}</div>
                  <div class="legend-value">${percentage}%</div>
              </div>
          `;
          legendContainer.innerHTML += itemHtml;
      });

      if (expenseChart) expenseChart.destroy();
      
      const centerTextPlugin = {
          id: 'centerText',
          afterDraw: (chart) => {
              const ctx = chart.ctx;
              const { width, height } = chart;
              ctx.restore();
              ctx.font = '700 1.5rem Inter';
              ctx.fillStyle = '#FFFFFF';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              const text = currencyFormatter.format(totalMonthlyExpense);
              ctx.fillText(text, width / 2, height / 2 - 10);
              
              ctx.font = '500 0.875rem Inter';
              ctx.fillStyle = '#9ca3af';
              ctx.fillText('Total Gastos', width / 2, height / 2 + 15);
              ctx.save();
          }
      };

      expenseChart = new Chart(document.getElementById('expenseChart').getContext('2d'), { 
          type: 'doughnut', 
          data: { 
              labels: sortedCategories, 
              datasets: [{ 
                  data: sortedValues, 
                  backgroundColor: colors,
                  borderWidth: 0,
                  spacing: 2
              }] 
          }, 
          options: { 
              responsive: true, 
              maintainAspectRatio: false, 
              cutout: '80%',
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              const label = context.label || '';
                              const value = context.parsed;
                              const percentage = totalMonthlyExpense > 0 ? ((value / totalMonthlyExpense) * 100).toFixed(1) + '%' : '0%';
                              return ` ${label}: ${currencyFormatter.format(value)} (${percentage})`;
                          }
                      }
                  }
              }
          },
          plugins: [centerTextPlugin]
      });
  }

  function renderTable(type) {
    if (type !== 'transactions') {
        const data = state[type];
        if (!data || data.length === 0) {
            appContent.innerHTML = `<div class="card text-center py-8"><p class="text-gray-500">No hay datos para mostrar.</p></div>`;
            return;
        }
        if (type === 'accounts') {
            renderAccountCards();
            return;
        }
        const headersConfig = { categories: ['Nombre', 'Tipo', 'Presupuesto'] };
        const headers = headersConfig[type];
        const dataRows = data.map(item => `
            <tr data-id="${item.ID}">
                <td>${item.Nombre}</td>
                <td><span class="badge ${item.Tipo}">${item.Tipo}</span></td>
                <td>${item.Tipo === 'gasto' ? currencyFormatter.format(item.Presupuesto || 0) : 'N/A'}</td>
                <td class="text-right"><button class="delete-btn"><i class="ph ph-trash"></i></button></td>
            </tr>`).join('');
        appContent.innerHTML = `<div class="card overflow-x-auto"><table class="w-full" data-type="${type}"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}<th></th></tr></thead><tbody>${dataRows}</tbody></table></div>`;
        return;
    }

    const transactions = state.transactions;
    const accountOptions = state.accounts.map(a => `<option value="${a.ID}">${a.Nombre}</option>`).join('');

    const filtersHtml = `
        <div class="card mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="filter-search" class="text-sm font-medium text-gray-400 block mb-2">Buscar por descripci√≥n</label>
                    <input type="text" id="filter-search" placeholder="Ej: Caf√©, Supermercado..." class="w-full p-2 bg-dark-bg border border-dark-border rounded-lg">
                </div>
                <div>
                    <label for="filter-account" class="text-sm font-medium text-gray-400 block mb-2">Cuenta</label>
                    <select id="filter-account" class="w-full p-2 bg-dark-bg border border-dark-border rounded-lg">
                        <option value="">Todas</option>
                        ${accountOptions}
                    </select>
                </div>
                <div>
                    <label for="filter-type" class="text-sm font-medium text-gray-400 block mb-2">Tipo</label>
                    <select id="filter-type" class="w-full p-2 bg-dark-bg border border-dark-border rounded-lg">
                        <option value="">Todos</option>
                        <option value="ingreso">Ingreso</option>
                        <option value="gasto">Gasto</option>
                    </select>
                </div>
                <div>
                    <label for="filter-month" class="text-sm font-medium text-gray-400 block mb-2">Mes</label>
                    <input type="month" id="filter-month" class="w-full p-2 bg-dark-bg border border-dark-border rounded-lg text-gray-400">
                </div>
            </div>
        </div>
    `;

    const dataRows = transactions.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha)).map(item => {
        const account = state.accounts.find(a => a.ID === item.CuentaID);
        return `
            <tr data-id="${item.ID}">
                <td>${new Date(item.Fecha).toLocaleDateString()}</td>
                <td>${item.Descripcion || ''}</td>
                <td>${item.Categoria}</td>
                <td class="${item.Tipo === 'ingreso' ? 'text-green-400' : 'text-red-400'} font-medium">${currencyFormatter.format(item.Monto)}</td>
                <td><span class="badge ${item.Tipo}">${item.Tipo}</span></td>
                <td>${account ? account.Nombre : 'N/A'}</td>
                <td class="text-right flex justify-end gap-4">
                    <button class="edit-btn text-gray-500 hover:text-blue-400" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="delete-btn text-gray-500 hover:text-red-400" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            </tr>`;
    }).join('');

    const tableHtml = `
        <div class="card overflow-x-auto">
            <table class="w-full" id="transactions-table" data-type="transactions">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Descripci√≥n</th>
                        <th>Categor√≠a</th>
                        <th>Monto</th>
                        <th>Tipo</th>
                        <th>Cuenta</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    ${transactions.length > 0 ? dataRows : `<tr><td colspan="7" class="text-center py-8 text-gray-500">No hay transacciones para mostrar.</td></tr>`}
                </tbody>
            </table>
        </div>
    `;

    appContent.innerHTML = filtersHtml + tableHtml;
  }

  function applyTransactionFilters() {
    const searchTerm = document.getElementById('filter-search').value.toLowerCase();
    const accountId = document.getElementById('filter-account').value;
    const type = document.getElementById('filter-type').value;
    const month = document.getElementById('filter-month').value;

    const filtered = state.transactions.filter(t => {
        const transactionMonth = t.Fecha ? t.Fecha.substring(0, 7) : '';
        const descriptionMatch = !searchTerm || (t.Descripcion && t.Descripcion.toLowerCase().includes(searchTerm));
        const accountMatch = !accountId || t.CuentaID === accountId;
        const typeMatch = !type || t.Tipo === type;
        const monthMatch = !month || transactionMonth === month;
        return descriptionMatch && accountMatch && typeMatch && monthMatch;
    });

    const tableBody = document.querySelector('#transactions-table tbody');
    if (!tableBody) return;

    const dataRows = filtered.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha)).map(item => {
        const account = state.accounts.find(a => a.ID === item.CuentaID);
        return `<tr data-id="${item.ID}">
                    <td>${new Date(item.Fecha).toLocaleDateString()}</td>
                    <td>${item.Descripcion || ''}</td>
                    <td>${item.Categoria}</td>
                    <td class="${item.Tipo === 'ingreso' ? 'text-green-400' : 'text-red-400'} font-medium">${currencyFormatter.format(item.Monto)}</td>
                    <td><span class="badge ${item.Tipo}">${item.Tipo}</span></td>
                    <td>${account ? account.Nombre : 'N/A'}</td>
                    <td class="text-right flex justify-end gap-4">
                        <button class="edit-btn text-gray-500 hover:text-blue-400" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                        <button class="delete-btn text-gray-500 hover:text-red-400" title="Eliminar"><i class="ph ph-trash"></i></button>
                    </td>
                </tr>`;
    }).join('');
    
    tableBody.innerHTML = filtered.length > 0 ? dataRows : `<tr><td colspan="7" class="text-center py-8 text-gray-500">No hay transacciones que coincidan con los filtros.</td></tr>`;
  }
  function renderAccountCards() {
      if (!state.accounts || state.accounts.length === 0) {
          appContent.innerHTML = `<div class="card text-center py-8"><p class="text-gray-500">No hay cuentas registradas.</p></div>`;
          return;
      }
      const accountsWithMovements = state.accounts.map(account => {
          const accountTransactions = state.transactions.filter(t => t.CuentaID === account.ID);
          const ingresos = accountTransactions.filter(t => t.Tipo === 'ingreso').reduce((sum, t) => sum + t.Monto, 0);
          const egresos = accountTransactions.filter(t => t.Tipo === 'gasto').reduce((sum, t) => sum + t.Monto, 0);
          const saldoActual = account.SaldoInicial + ingresos - egresos;
          return { ...account, ingresos, egresos, saldoActual };
      });
      const cardsHtml = accountsWithMovements.map(account => `
          <div class="cuenta-card-new" data-id="${account.ID}">
              <div class="flex justify-between items-start mb-4">
                  <div class="card-title-new">üí≥ ${account.Nombre}</div>
                  <button class="delete-btn text-gray-400 hover:text-red-400 text-xl"><i class="ph ph-trash"></i></button>
              </div>
              <div class="card-data-new"><span>üìà Ingresos:</span><span class="ingreso-val-new">${currencyFormatter.format(account.ingresos)}</span></div>
              <div class="card-data-new"><span>üìâ Egresos:</span><span class="egreso-val-new">${currencyFormatter.format(account.egresos)}</span></div>
              <div class="card-saldo-highlight-new"><span class="saldo-label-new">Saldo Actual:</span><span class="saldo-value-new">${currencyFormatter.format(account.saldoActual)}</span></div>
              <div class="text-xs text-gray-400 mt-2 text-center">Tipo: ${account.Tipo} ‚Ä¢ Saldo inicial: ${currencyFormatter.format(account.SaldoInicial)}</div>
          </div>
      `).join('');
      appContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" data-type="accounts">${cardsHtml}</div>`;
  }

  function renderGoals() {
    if (!state.goals || state.goals.length === 0) { 
        appContent.innerHTML = `<div class="card text-center py-8"><p class="text-gray-500">No hay metas definidas.</p></div>`; 
        return; 
    }
    appContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" data-type="goals">${state.goals.map(goal => {
        const percentage = goal.MontoObjetivo > 0 ? Math.min((goal.MontoActual / goal.MontoObjetivo) * 100, 100) : 0;
        return `<div class="card flex flex-col justify-between" data-id="${goal.ID}">
            <div>
                <div class="flex justify-between items-start"><h3 class="card-title">${goal.Nombre}</h3><button class="delete-btn"><i class="ph ph-trash"></i></button></div>
                <p class="text-xl font-bold text-main">${currencyFormatter.format(goal.MontoActual || 0)}</p>
                <p class="text-sm text-gray-500 mb-2">de ${currencyFormatter.format(goal.MontoObjetivo)}</p>
                <div class="w-full bg-white/10 rounded-full h-2.5 mb-4"><div class="bg-main h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
            </div>
            <button class="add-contribution-btn main-btn w-full" data-goal-id="${goal.ID}" data-goal-name="${goal.Nombre}">Aportar a Meta</button>
        </div>`;
    }).join('')}</div>`;
  }
  
  function renderDebts() {
    if (!state.debts || state.debts.length === 0) { appContent.innerHTML = `<div class="card text-center py-8"><p class="text-gray-500">No hay deudas registradas.</p></div>`; return; }
    appContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" data-type="debts">${state.debts.map(debt => {
        const totalPaid = debt.MontoPagado || 0;
        const remaining = debt.MontoTotal - totalPaid;
        const percentage = debt.MontoTotal > 0 ? Math.min((totalPaid / debt.MontoTotal) * 100, 100) : 0;
        return `<div class="card flex flex-col justify-between" data-id="${debt.ID}">
            <div>
                <div class="flex justify-between items-start"><h3 class="card-title">${debt.Nombre}</h3><button class="delete-btn"><i class="ph ph-trash"></i></button></div>
                <p class="text-xl font-bold text-red-500">${currencyFormatter.format(remaining)}</p>
                <p class="text-sm text-gray-500 mb-2">restante de ${currencyFormatter.format(debt.MontoTotal)}</p>
                <div class="w-full bg-white/10 rounded-full h-2.5 mb-4"><div class="bg-red-500 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
            </div>
            <button class="add-payment-btn main-btn w-full !bg-red-500 hover:!bg-red-600" data-debt-id="${debt.ID}" data-debt-name="${debt.Nombre}">Realizar Pago</button>
        </div>`;
    }).join('')}</div>`;
  }
  
  // --- MODALS ---
  function createModalShell(title, formId, content, buttons) {
    return `<div class="w-full max-w-lg bg-[#252525] text-gray-200 rounded-2xl shadow-2xl p-8 animate-scale-in">
        <div class="text-center mb-6"><div id="modal-title" class="inline-block font-bold text-xl px-4 py-2 rounded-lg border-2 border-main bg-main text-white transition-all">${title}</div></div>
        <form id="${formId}" class="space-y-5">
            ${content}
            <div id="message-container" class="text-center py-2 rounded-lg text-sm font-medium hidden"></div>
            <div class="flex gap-4 pt-4">${buttons}</div>
        </form>
    </div>`;
  }

  function showTransactionModal(transactionId = null) {
    if (!state.accounts || state.accounts.length === 0) {
        showNotification('error', 'Crea una cuenta antes de a√±adir transacciones.');
        return;
    }

    const isEditMode = transactionId !== null;
    const transaction = isEditMode ? state.transactions.find(t => t.ID === transactionId) : {};
    
    const accountOptions = state.accounts.map(a => `<option value="${a.ID}" ${transaction.CuentaID === a.ID ? 'selected' : ''}>${a.Nombre}</option>`).join('');
    const categoryDatalist = state.categories.map(c => `<option value="${c.Nombre}"></option>`).join('');
    const today = new Date().toISOString().split('T')[0];
    
    const content = `
        <input type="hidden" id="tipo" value="${transaction.Tipo || ''}" required>
        <input type="hidden" id="transactionId" value="${transaction.ID || ''}">
        <div class="flex gap-4">
            <div class="flex-1">
                <div class="flex justify-between items-center mb-2"><label for="categoria" class="font-semibold text-sm">üè∑Ô∏è Categor√≠a</label><span id="tipo-badge" class="px-2 py-0.5 text-xs font-bold rounded-full bg-gray-600">--</span></div>
                <input list="lista-categorias" id="categoria" value="${transaction.Categoria || ''}" placeholder="Escribe para buscar..." class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required><datalist id="lista-categorias">${categoryDatalist}</datalist>
            </div>
            <div class="w-44">
                <label for="fecha" class="font-semibold text-sm mb-2 block">üóìÔ∏è Fecha</label><input type="date" id="fecha" value="${transaction.Fecha ? transaction.Fecha.split('T')[0] : today}" class="w-full p-3 bg-white text-black rounded-lg border-2 border-gray-300" required>
            </div>
        </div>
        <div class="flex gap-4">
            <div class="flex-1">
                <label for="cuenta" class="font-semibold text-sm mb-2 block">üí≥ Cuenta</label><select id="cuenta" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required>${accountOptions}</select>
            </div>
            <div class="flex-1">
                <label for="monto" class="font-semibold text-sm mb-2 block">üíµ Monto</label>
                <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-main">$</span><input type="number" id="monto" value="${transaction.Monto || ''}" placeholder="0.00" min="0.01" step="0.01" class="w-full p-3 pl-8 bg-white text-black rounded-lg border-2 border-gray-300" required></div>
            </div>
        </div>
        <div><label for="descripcion" class="font-semibold text-sm mb-2 block">üìù Descripci√≥n (Opcional)</label><textarea id="descripcion" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" rows="2">${transaction.Descripcion || ''}</textarea></div>`;
    
    const buttons = `<button type="button" class="cancel-btn w-full p-3 bg-white/10 rounded-lg font-semibold hover:bg-white/20">Cancelar</button><button type="submit" class="submit-btn w-full p-3 bg-main rounded-lg font-semibold hover:bg-pink-700 disabled:bg-gray-500">${isEditMode ? 'Guardar Cambios' : 'Registrar'}</button>`;
    
    showModal(createModalShell(isEditMode ? 'Editar Transacci√≥n' : 'Nueva Transacci√≥n', 'transaction-form', content, buttons));

    const categoriaInput = document.getElementById('categoria');
    const updateTypeBadge = () => {
        const tipoBadge = document.getElementById('tipo-badge');
        const tipoInput = document.getElementById('tipo');
        const modalTitle = document.getElementById('modal-title');
        const selectedCategory = state.categories.find(c => c.Nombre.toLowerCase() === categoriaInput.value.toLowerCase());
        if (selectedCategory) {
            tipoInput.value = selectedCategory.Tipo;
            tipoBadge.textContent = selectedCategory.Tipo;
            tipoBadge.className = `px-2 py-0.5 text-xs font-bold rounded-full text-white ${selectedCategory.Tipo === 'ingreso' ? 'bg-green-500' : 'bg-red-500'}`;
            modalTitle.className = `inline-block font-bold text-xl px-4 py-2 rounded-lg border-2 text-white transition-all ${selectedCategory.Tipo === 'ingreso' ? 'bg-green-500 border-green-500' : 'bg-red-500 border-red-500'}`;
        } else {
            tipoInput.value = ''; tipoBadge.textContent = '--'; tipoBadge.className = 'px-2 py-0.5 text-xs font-bold rounded-full bg-gray-600';
            modalTitle.className = 'inline-block font-bold text-xl px-4 py-2 rounded-lg border-2 border-main bg-main text-white transition-all';
        }
    };
    categoriaInput.addEventListener('input', updateTypeBadge);
    if (isEditMode) {
        updateTypeBadge();
    }
  }

  function showAccountModal() {
    const content = `
        <div><label for="nombre" class="font-semibold text-sm mb-2 block">üè¶ Nombre de la Cuenta</label><input type="text" id="nombre" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required></div>
        <div class="flex gap-4">
            <div class="flex-1"><label for="tipo" class="font-semibold text-sm mb-2 block">Tipo</label><select id="tipo" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required><option>Efectivo</option><option>Banco</option><option>Digital</option></select></div>
            <div class="flex-1"><label for="saldo" class="font-semibold text-sm mb-2 block">üíµ Saldo Inicial</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-main">$</span><input type="number" id="saldo" placeholder="0.00" step="0.01" class="w-full p-3 pl-8 bg-white text-black rounded-lg border-2 border-gray-300" required></div></div>
        </div>`;
    const buttons = `<button type="button" class="cancel-btn w-full p-3 bg-white/10 rounded-lg font-semibold hover:bg-white/20">Cancelar</button><button type="submit" class="submit-btn w-full p-3 bg-main rounded-lg font-semibold hover:bg-pink-700 disabled:bg-gray-500">Guardar Cuenta</button>`;
    showModal(createModalShell('Nueva Cuenta', 'account-form', content, buttons));
  }
  function showCategoryModal() {
    const content = `
        <div><label for="nombre" class="font-semibold text-sm mb-2 block">üè∑Ô∏è Nombre de la Categor√≠a</label><input type="text" id="nombre" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required></div>
        <div><label for="tipo" class="font-semibold text-sm mb-2 block">Tipo</label><select id="tipo" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required><option value="gasto">Gasto</option><option value="ingreso">Ingreso</option></select></div>
        <div id="presupuesto-container"><label for="presupuesto" class="font-semibold text-sm mb-2 block">üíµ Presupuesto Mensual (Opcional)</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-main">$</span><input type="number" id="presupuesto" placeholder="0.00" step="0.01" class="w-full p-3 pl-8 bg-white text-black rounded-lg border-2 border-gray-300"></div></div>`;
    const buttons = `<button type="button" class="cancel-btn w-full p-3 bg-white/10 rounded-lg font-semibold hover:bg-white/20">Cancelar</button><button type="submit" class="submit-btn w-full p-3 bg-main rounded-lg font-semibold hover:bg-pink-700 disabled:bg-gray-500">Guardar Categor√≠a</button>`;
    showModal(createModalShell('Nueva Categor√≠a', 'category-form', content, buttons));
    const tipoSelect = document.getElementById('tipo'), presupuestoContainer = document.getElementById('presupuesto-container');
    tipoSelect.addEventListener('change', () => { presupuestoContainer.style.display = tipoSelect.value === 'gasto' ? 'block' : 'none'; });
  }

  function showGoalModal() {
    const accountOptions = state.accounts.map(a => `<option value="${a.ID}">${a.Nombre}</option>`).join('');
    const content = `
        <div><label for="nombre" class="font-semibold text-sm mb-2 block">üéØ Nombre de la Meta</label><input type="text" id="nombre" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required></div>
        <div class="flex gap-4">
            <div class="flex-1"><label for="monto-objetivo" class="font-semibold text-sm mb-2 block">üíµ Monto Objetivo</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-main">$</span><input type="number" id="monto-objetivo" placeholder="0.00" min="0.01" step="0.01" class="w-full p-3 pl-8 bg-white text-black rounded-lg border-2 border-gray-300" required></div></div>
            <div class="flex-1"><label for="monto-actual" class="font-semibold text-sm mb-2 block">üíµ Ahorro Inicial (Opcional)</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-main">$</span><input type="number" id="monto-actual" placeholder="0.00" step="0.01" class="w-full p-3 pl-8 bg-white text-black rounded-lg border-2 border-gray-300"></div></div>
        </div>
        <div>
            <label for="cuenta-asociada" class="font-semibold text-sm mb-2 block">üè¶ Cuenta Asociada (Obligatorio)</label>
            <select id="cuenta-asociada" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required>
                <option value="" disabled selected>Selecciona una cuenta...</option>
                ${accountOptions}
            </select>
        </div>`;
    const buttons = `<button type="button" class="cancel-btn w-full p-3 bg-white/10 rounded-lg font-semibold hover:bg-white/20">Cancelar</button><button type="submit" class="submit-btn w-full p-3 bg-main rounded-lg font-semibold hover:bg-pink-700 disabled:bg-gray-500">Guardar Meta</button>`;
    showModal(createModalShell('Nueva Meta de Ahorro', 'goal-form', content, buttons));
  }

  function showDebtModal() {
    const content = `<div><label for="nombre" class="font-semibold text-sm mb-2 block">üí≥ Nombre de la Deuda</label><input type="text" id="nombre" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required></div>
        <div><label for="monto-total" class="font-semibold text-sm mb-2 block">üíµ Monto Total</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-main">$</span><input type="number" id="monto-total" placeholder="0.00" min="0.01" step="0.01" class="w-full p-3 pl-8 bg-white text-black rounded-lg border-2 border-gray-300" required></div></div>`;
    const buttons = `<button type="button" class="cancel-btn w-full p-3 bg-white/10 rounded-lg font-semibold hover:bg-white/20">Cancelar</button><button type="submit" class="submit-btn w-full p-3 bg-main rounded-lg font-semibold hover:bg-pink-700 disabled:bg-gray-500">Guardar Deuda</button>`;
    showModal(createModalShell('Nueva Deuda', 'debt-form', content, buttons));
  }

  function showContributionModal(goalId, goalName) {
    const accountOptions = state.accounts.map(a => `<option value="${a.ID}">${a.Nombre}</option>`).join('');
    const today = new Date().toISOString().split('T')[0];
    const content = `
        <input type="hidden" id="goalId" value="${goalId}"><input type="hidden" id="goalName" value="${goalName}">
        <div class="flex gap-4">
            <div class="flex-1"><label for="sourceAccount" class="font-semibold text-sm mb-2 block">üí≥ Cuenta de Origen</label><select id="sourceAccount" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required><option value="" disabled selected>Selecciona...</option>${accountOptions}</select></div>
            <div class="flex-1"><label for="monto" class="font-semibold text-sm mb-2 block">üíµ Monto a Aportar</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-main">$</span><input type="number" id="monto" placeholder="0.00" min="0.01" step="0.01" class="w-full p-3 pl-8 bg-white text-black rounded-lg border-2 border-gray-300" required></div></div>
        </div>
        <div><label for="fecha" class="font-semibold text-sm mb-2 block">üóìÔ∏è Fecha</label><input type="date" id="fecha" value="${today}" class="w-full p-3 bg-white text-black rounded-lg border-2 border-gray-300" required></div>
        <div><label for="descripcion" class="font-semibold text-sm mb-2 block">üìù Descripci√≥n (Opcional)</label><textarea id="descripcion" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" rows="2" placeholder="Ej: Ahorro quincenal"></textarea></div>`;
    const buttons = `<button type="button" class="cancel-btn w-full p-3 bg-white/10 rounded-lg font-semibold hover:bg-white/20">Cancelar</button><button type="submit" class="submit-btn w-full p-3 bg-main rounded-lg font-semibold hover:bg-pink-700 disabled:bg-gray-500">Registrar Aporte</button>`;
    showModal(createModalShell(`Aporte a: ${goalName}`, 'contribution-form', content, buttons));
  }
  
  function showDebtPaymentModal(debtId, debtName) {
    const accountOptions = state.accounts.map(a => `<option value="${a.ID}">${a.Nombre}</option>`).join('');
    const today = new Date().toISOString().split('T')[0];
    const content = `
        <input type="hidden" id="debtId" value="${debtId}"><input type="hidden" id="debtName" value="${debtName}">
        <div class="flex gap-4">
            <div class="flex-1"><label for="sourceAccount" class="font-semibold text-sm mb-2 block">üí≥ Cuenta de Origen</label><select id="sourceAccount" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" required><option value="" disabled selected>Selecciona...</option>${accountOptions}</select></div>
            <div class="flex-1"><label for="monto" class="font-semibold text-sm mb-2 block">üíµ Monto a Pagar</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-main">$</span><input type="number" id="monto" placeholder="0.00" min="0.01" step="0.01" class="w-full p-3 pl-8 bg-white text-black rounded-lg border-2 border-gray-300" required></div></div>
        </div>
        <div><label for="fecha" class="font-semibold text-sm mb-2 block">üóìÔ∏è Fecha</label><input type="date" id="fecha" value="${today}" class="w-full p-3 bg-white text-black rounded-lg border-2 border-gray-300" required></div>
        <div><label for="descripcion" class="font-semibold text-sm mb-2 block">üìù Descripci√≥n (Opcional)</label><textarea id="descripcion" class="w-full p-3 bg-white/10 border-2 border-white/20 rounded-lg focus:border-main outline-none" rows="2" placeholder="Ej: Pago mensual"></textarea></div>`;
    const buttons = `<button type="button" class="cancel-btn w-full p-3 bg-white/10 rounded-lg font-semibold hover:bg-white/20">Cancelar</button><button type="submit" class="submit-btn w-full p-3 bg-red-600 rounded-lg font-semibold hover:bg-red-700 disabled:bg-gray-500">Registrar Pago</button>`;
    showModal(createModalShell(`Pago a: ${debtName}`, 'debt-payment-form', content, buttons));
  }

  // --- HELPERS ---
  function showModal(content) {
    modalContainer.innerHTML = content;
    modalContainer.style.display = 'flex';
  }

  function hideModal() {
    modalContainer.style.display = 'none';
    modalContainer.innerHTML = '';
  }

  function showNotification(type, message) {
    const icon = type === 'success' ? '‚úîÔ∏è' : '‚ùå';
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `<span>${icon}</span> ${message}`;
    notificationContainer.appendChild(notification);
    
    const fadeTimeout = setTimeout(() => {
        notification.classList.add('fade-out');
    }, 3000);
    
    const removeTimeout = setTimeout(() => {
        if (notification && notification.parentNode) {
            notification.remove();
        }
    }, 3500);
    
    notification.addEventListener('click', () => {
        clearTimeout(fadeTimeout);
        clearTimeout(removeTimeout);
        notification.remove();
    });
  }

  // --- EVENT HANDLERS ---
  refreshBtn.addEventListener('click', () => {
    showNotification('success', 'Actualizando datos...');
    initialize();
  });
  
  appContent.addEventListener('click', e => {
    const editBtn = e.target.closest('.edit-btn');
    if (editBtn) {
        const row = editBtn.closest('[data-id]');
        showTransactionModal(row.dataset.id);
    }
    const deleteBtn = e.target.closest('.delete-btn');
    if (deleteBtn) {
        const row = deleteBtn.closest('[data-id]');
        const type = row.closest('[data-type]').dataset.type;
        showModal(`<div class="bg-dark-card border border-dark-border p-8 rounded-xl w-full max-w-sm text-center"><h3 class="text-2xl font-bold text-white">Confirmar Eliminaci√≥n</h3><p class="text-gray-400">¬øEst√°s seguro de que quieres eliminar esto?</p><div class="flex justify-center gap-4 pt-4"><button type="button" class="cancel-btn w-full p-3 bg-white/10 rounded-lg font-semibold hover:bg-white/20">Cancelar</button><button type="button" id="confirm-delete-btn" class="submit-btn w-full p-3 bg-red-600 rounded-lg font-semibold hover:bg-red-700">Eliminar</button></div></div>`);
        document.getElementById('confirm-delete-btn').onclick = () => handleDelete(type, row.dataset.id);
    }
    const contributionBtn = e.target.closest('.add-contribution-btn');
    if (contributionBtn) {
        const goalId = contributionBtn.dataset.goalId;
        const goalName = contributionBtn.dataset.goalName;
        showContributionModal(goalId, goalName);
    }
    const paymentBtn = e.target.closest('.add-payment-btn');
    if (paymentBtn) {
        const debtId = paymentBtn.dataset.debtId;
        const debtName = paymentBtn.dataset.debtName;
        showDebtPaymentModal(debtId, debtName);
    }
  });

  appContent.addEventListener('input', e => {
    if (e.target.closest('#filter-search, #filter-account, #filter-type, #filter-month')) {
        applyTransactionFilters();
    }
  });

  appContent.addEventListener('submit', e => {
      e.preventDefault();
  });

  modalContainer.addEventListener('click', e => {
    if (e.target.closest('.cancel-btn')) hideModal();
  });
  
  modalContainer.addEventListener('submit', e => {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector('.submit-btn');
    if (!submitBtn) return;
    const originalBtnText = submitBtn.textContent;
    submitBtn.textContent = 'Guardando...';
    submitBtn.disabled = true;
    let data, functionName, stateKey;
    try {
      const get = id => form.querySelector(`#${id}`).value;
      const getNum = id => parseFloat(form.querySelector(`#${id}`).value) || 0;
      
      switch (form.id) {
        case 'transaction-form':
            const transactionId = get('transactionId');
            data = { Tipo: get('tipo'), Fecha: get('fecha'), Descripcion: get('descripcion'), Monto: getNum('monto'), CuentaID: get('cuenta'), Categoria: get('categoria') };
            if(!get('tipo')) throw new Error("Selecciona una categor√≠a v√°lida.");
            if (transactionId) {
                google.script.run
                    .withSuccessHandler(res => {
                        if (res.success) {
                            const index = state.transactions.findIndex(t => t.ID === transactionId);
                            if (index !== -1) {
                                state.transactions[index] = { ...state.transactions[index], ...data };
                            }
                            showNotification('success', 'Transacci√≥n actualizada.');
                            hideModal();
                            renderCurrentView(); 
                        } else { showNotification('error', `Error: ${res.message}`); }
                    })
                    .withFailureHandler(err => showNotification('error', `Error: ${err.message}`))
                    .updateItem('transactions', transactionId, data);
                submitBtn.textContent = originalBtnText; submitBtn.disabled = false;
                return;
            } else {
                functionName = 'addTransaction';
                stateKey = 'transactions';
            }
            break;
        case 'account-form': data = { Nombre: get('nombre'), Tipo: get('tipo'), SaldoInicial: getNum('saldo') }; functionName = 'addAccount'; stateKey = 'accounts'; break;
        case 'category-form': data = { Nombre: get('nombre'), Tipo: get('tipo'), Presupuesto: getNum('presupuesto') }; functionName = 'addCategory'; stateKey = 'categories'; break;
        case 'goal-form': data = { Nombre: get('nombre'), MontoObjetivo: getNum('monto-objetivo'), MontoActual: getNum('monto-actual'), CuentaAsociadaID: get('cuenta-asociada') }; functionName = 'addGoal'; stateKey = 'goals'; break;
        case 'debt-form': data = { Nombre: get('nombre'), MontoTotal: getNum('monto-total'), MontoPagado: 0 }; functionName = 'addDebt'; stateKey = 'debts'; break;
        case 'contribution-form':
          const contributionData = { goalId: get('goalId'), goalName: get('goalName'), sourceAccountId: get('sourceAccount'), amount: getNum('monto'), fecha: get('fecha'), description: get('descripcion') };
          handleAddContribution(contributionData).finally(() => { submitBtn.textContent = originalBtnText; submitBtn.disabled = false; });
          return;
        case 'debt-payment-form':
          const paymentData = { debtId: get('debtId'), debtName: get('debtName'), sourceAccountId: get('sourceAccount'), amount: getNum('monto'), fecha: get('fecha'), description: get('descripcion') };
          handleAddPayment(paymentData).finally(() => { submitBtn.textContent = originalBtnText; submitBtn.disabled = false; });
          return;
        default: throw new Error("Formulario desconocido.");
      }
      handleAdd(stateKey, functionName, data).finally(() => { submitBtn.textContent = originalBtnText; submitBtn.disabled = false; });
    } catch (error) {
      showNotification('error', error.message);
      submitBtn.textContent = originalBtnText;
      submitBtn.disabled = false;
    }
  });

  // --- BACKEND COMMUNICATION ---
  function handleAdd(stateKey, functionName, data) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(res => {
          if (res.success) {
            state[stateKey].push(res.item);
            showNotification('success', 'Elemento guardado.');
            hideModal();
            renderCurrentView();
            resolve();
          } else {
            showNotification('error', `Error: ${res.message || 'Error desconocido del servidor.'}`);
            reject(new Error(res.message));
          }
        })
        .withFailureHandler(err => {
          showNotification('error', `Error de conexi√≥n: ${err.message}`);
          reject(err);
        })
        [functionName](data);
    });
  }
  
  function handleDelete(type, id) {
    const fnMap = { transactions: 'deleteTransaction', accounts: 'deleteAccount', categories: 'deleteCategory', goals: 'deleteGoal', debts: 'deleteDebt' };
    google.script.run.withSuccessHandler(res => {
      if (res.success) {
        state[type] = state[type].filter(item => item.ID != res.id);
        showNotification('success', 'Elemento eliminado.');
        hideModal();
        renderCurrentView();
      } else { showNotification('error', `Error: ${res.message}`); }
    }).withFailureHandler(err => showNotification('error', `Error de conexi√≥n: ${err.message}`))[fnMap[type]](id);
  }
  
  function handleAddContribution(contributionData) {
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(res => {
                if (res.success) {
                    res.transactions.forEach(t => state.transactions.push(t));
                    const goal = state.goals.find(g => g.ID === res.updatedGoal.id);
                    if (goal) { goal.MontoActual = res.updatedGoal.newAmount; }
                    showNotification('success', 'Aporte registrado.');
                    hideModal();
                    renderCurrentView();
                    resolve();
                } else { showNotification('error', `Error: ${res.message}`); reject(new Error(res.message)); }
            })
            .withFailureHandler(err => { showNotification('error', `Error: ${err.message}`); reject(err); })
            .addContribution(contributionData);
    });
  }
  
  function handleAddPayment(paymentData) {
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(res => {
                if (res.success) {
                    state.transactions.push(res.transaction);
                    const debt = state.debts.find(d => d.ID === res.updatedDebt.id);
                    if (debt) { debt.MontoPagado = res.updatedDebt.newPaidAmount; }
                    showNotification('success', 'Pago registrado.');
                    hideModal();
                    renderCurrentView();
                    resolve();
                } else { showNotification('error', `Error: ${res.message}`); reject(new Error(res.message)); }
            })
            .withFailureHandler(err => { showNotification('error', `Error de conexi√≥n: ${err.message}`); reject(err); })
            .addDebtPayment(paymentData);
    });
  }

  // --- L√ìGICA PARA EL MEN√ö M√ìVIL ---
  function populateMobileMenu() {
    const navButtons = document.querySelectorAll('#nav-links .nav-tab');
    let menuHtml = '';
    navButtons.forEach(button => {
        const view = button.dataset.view;
        const iconHtml = button.querySelector('i').outerHTML;
        const text = button.querySelector('span').textContent;
        menuHtml += `<button data-view="${view}" class="mobile-nav-button">${iconHtml}<span>${text}</span></button>`;
    });
    mobileMenu.innerHTML = menuHtml;
  }
  function toggleMobileMenu() { mobileMenu.classList.toggle('hidden'); }
  hamburgerBtn.addEventListener('click', toggleMobileMenu);
  mobileMenu.addEventListener('click', e => {
    const button = e.target.closest('.mobile-nav-button');
    if (button) {
        navigateTo(button.dataset.view);
        toggleMobileMenu();
    }
  });
  populateMobileMenu();
  
  // --- APP START ---
  initialize();
});
</script>
